(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[471],{47128:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/invoices",function(){return s(32981)}])},32981:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return InvoicesPage}});var a=s(85893),n=s(67294),i=s(36008),l=s(39367),r=s(46435);function InvoicesPage(){let{user:e,loading:t}=(0,l.a)(),[d,c]=(0,n.useState)([]),[o,u]=(0,n.useState)([]),[m,x]=(0,n.useState)(!0),[p,h]=(0,n.useState)(""),[v,y]=(0,n.useState)(!1),[g,b]=(0,n.useState)({patientId:"",amountCents:"",currency:"USD",notes:""}),[N,j]=(0,n.useState)([{description:"",quantity:1,unitCents:0}]);(0,n.useEffect)(()=>{if(!t&&!e){window.location.href="/login";return}e&&("ADMIN"===e.role||"RECEPTIONIST"===e.role)&&loadAll()},[e,t]);let loadAll=async()=>{try{x(!0);let[e,t]=await Promise.all([r.iR.list().catch(()=>({success:!1,data:[]})),r.Nq.getPatients().catch(()=>({success:!1,data:[]}))]),s=e&&void 0!==e.success?e.data:e,a=t&&void 0!==t.success?t.data:t,n=Array.isArray(s)?s:(null==s?void 0:s.invoices)||(null==s?void 0:s.data)||[],i=Array.isArray(a)?a:(null==a?void 0:a.patients)||(null==a?void 0:a.data)||[];c(n||[]),u(i||[])}catch(e){h(e.message||"Failed to load invoices")}finally{x(!1)}},f=N.reduce((e,t)=>e+Number(t.quantity||0)*Number(t.unitCents||0),0),onCreate=async e=>{e.preventDefault();try{y(!0);let e={patientId:parseInt(g.patientId),amountCents:f||(g.amountCents?parseInt(g.amountCents):void 0),currency:g.currency,notes:g.notes||void 0},t=await r.iR.create(e);if(!t.success)throw Error(t.error||"Failed");b({patientId:"",amountCents:"",currency:"USD",notes:""}),j([{description:"",quantity:1,unitCents:0}]),await loadAll()}catch(e){var t,s;h((null===(s=e.response)||void 0===s?void 0:null===(t=s.data)||void 0===t?void 0:t.error)||"Failed to create invoice")}finally{y(!1)}},removeItem=e=>j(t=>t.filter((t,s)=>s!==e)),updateItem=(e,t)=>j(s=>s.map((s,a)=>a===e?{...s,...t}:s)),downloadPdf=async e=>{let{jsPDF:t}=await Promise.all([s.e(655),s.e(847),s.e(910)]).then(s.bind(s,91819)),a=new t;a.setFontSize(16),a.text("Invoice",20,20),a.setFontSize(11),a.text("Invoice #".concat(e.invoiceNumber||e.id),20,30),a.text("Patient ID: ".concat(e.patientId),20,36),a.text("Amount: ".concat(e.amountCents?e.amountCents/100:e.amount," ").concat(e.currency||"USD"),20,42),e.notes&&a.text("Notes: ".concat(e.notes),20,48,{maxWidth:170}),a.save("invoice-".concat(e.invoiceNumber||e.id,".pdf"))},emailInvoice=async e=>{try{let t=await r.iR.sendEmail(e.id);if(!t.success)throw Error(t.error||"Failed to send");alert("Invoice email queued/sent")}catch(e){alert(e.message||"Failed to send invoice email")}};return t||m?(0,a.jsx)(i.Z,{children:(0,a.jsx)("div",{className:"flex justify-center items-center h-64",children:(0,a.jsx)("div",{className:"text-gray-500",children:"Loading invoices..."})})}):e&&("ADMIN"===e.role||"RECEPTIONIST"===e.role)?(0,a.jsx)(i.Z,{children:(0,a.jsxs)("div",{className:"px-4 sm:px-0",children:[(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("h1",{className:"text-4xl font-bold text-gray-900 mb-2",children:"Invoices"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Create and manage invoices"})]}),p&&(0,a.jsx)("div",{className:"mb-6 rounded-lg bg-red-50 border border-red-200 p-4",children:(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("svg",{className:"h-5 w-5 text-red-400",fill:"currentColor",viewBox:"0 0 20 20",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),(0,a.jsx)("div",{className:"ml-3 text-sm text-red-700",children:p})]})}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{className:"lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-200 p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Existing Invoices"}),Array.isArray(d)&&0!==d.length?(0,a.jsx)("div",{className:"divide-y divide-gray-200",children:d.map(e=>(0,a.jsx)("div",{className:"py-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-gray-600",children:"Invoice"}),(0,a.jsxs)("p",{className:"text-lg font-semibold text-gray-900",children:["#",e.invoiceNumber||e.id]}),(0,a.jsxs)("p",{className:"text-sm text-gray-600",children:["Patient ID: ",e.patientId]})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("p",{className:"text-lg font-semibold text-gray-900",children:[e.amountCents?e.amountCents/100:e.amount," ",e.currency||"USD"]}),(0,a.jsx)("span",{className:"text-xs inline-flex mt-1 px-2 py-1 rounded-full border bg-gray-50 text-gray-700",children:e.status}),(0,a.jsxs)("div",{className:"mt-2 space-x-2",children:[(0,a.jsx)("button",{onClick:()=>downloadPdf(e),className:"px-3 py-1 text-sm border rounded",children:"Download PDF"}),(0,a.jsx)("button",{onClick:()=>emailInvoice(e),className:"px-3 py-1 text-sm border rounded",children:"Email"})]})]})]})},e.id))}):(0,a.jsx)("p",{className:"text-gray-500",children:"No invoices found."})]}),(0,a.jsxs)("div",{className:"bg-white rounded-xl shadow-lg border border-gray-200 p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Create Invoice"}),(0,a.jsxs)("form",{onSubmit:onCreate,className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Patient *"}),(0,a.jsxs)("select",{required:!0,value:g.patientId,onChange:e=>b({...g,patientId:e.target.value}),className:"w-full px-3 py-2 border rounded-lg",children:[(0,a.jsx)("option",{value:"",children:"Select patient"}),o.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.firstName," ",e.lastName," (#",e.id,")"]},e.id))]})]}),(0,a.jsxs)("div",{className:"border rounded-lg p-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"Line Items"}),(0,a.jsx)("button",{type:"button",onClick:()=>j(e=>[...e,{description:"",quantity:1,unitCents:0}]),className:"px-2 py-1 text-xs border rounded",children:"+ Add"})]}),(0,a.jsx)("div",{className:"space-y-2",children:N.map((e,t)=>(0,a.jsxs)("div",{className:"grid grid-cols-6 gap-2 items-center",children:[(0,a.jsx)("input",{type:"text",placeholder:"Description",className:"col-span-3 px-2 py-1 border rounded",value:e.description,onChange:e=>updateItem(t,{description:e.target.value})}),(0,a.jsx)("input",{type:"number",min:1,placeholder:"Qty",className:"px-2 py-1 border rounded",value:e.quantity,onChange:e=>updateItem(t,{quantity:parseInt(e.target.value||"1")})}),(0,a.jsx)("input",{type:"number",min:0,placeholder:"Unit (cents)",className:"px-2 py-1 border rounded",value:e.unitCents,onChange:e=>updateItem(t,{unitCents:parseInt(e.target.value||"0")})}),(0,a.jsx)("button",{type:"button",onClick:()=>removeItem(t),className:"px-2 py-1 text-xs border rounded",children:"Remove"})]},t))}),(0,a.jsxs)("div",{className:"text-right text-sm text-gray-700 mt-2",children:["Total: ",f/100," ",g.currency]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Currency"}),(0,a.jsx)("input",{type:"text",value:g.currency,onChange:e=>b({...g,currency:e.target.value}),className:"w-full px-3 py-2 border rounded-lg"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),(0,a.jsx)("textarea",{rows:3,value:g.notes,onChange:e=>b({...g,notes:e.target.value}),className:"w-full px-3 py-2 border rounded-lg"})]}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)("button",{type:"submit",disabled:v,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50",children:v?"Creatingâ€¦":"Create Invoice"})})]})]})]})]})}):null}}},function(e){e.O(0,[424,8,774,888,179],function(){return e(e.s=47128)}),_N_E=e.O()}]);